<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<script
    src="https://code.easypz.io/easypz.latest.min.js">
</script>

<style>
    body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 5%;
        background-color: beige;
    }

    svg {
        margin: 1%;
        background-color: white;
    }

    .algorithm_header {
        font-size: 2em;
        font-weight: bold;
        margin-top: 100px;
        margin-bottom: 20px;
    }
</style>

<body>
</body>

<script src="./dist/dist.js"></script>
<script>

    let drawGraph = (svg, g, algorithm = undefined) => {
        const attr_height = 15
        const table_width = 70
        const depth_distance = 150
        const header_height = 20
        const table_vert_space = 100

        let line = d3.line()
            .curve(d3.curveBasis);

        visg = svg.append('g')
            .attr('transform', 'translate(20, 20)')

        // draw tables
        tablegroups = visg.selectAll(".tables")
            .data(g.tables)
            .enter()
            .append('g')
            .attr('transform', d => 
                "translate(" + (d.depth*depth_distance) + "," 
                + g.tableIndex[d.depth].indexOf(d) * table_vert_space + ")" )

        tablegroups.append('rect')
            .attr('width', table_width)
            .attr('height', d => d.attributes.length * attr_height + header_height)  
            .attr('fill', 'black')
            .attr('stroke', 'gray')

        tablegroups.append('text')
            .attr('x', table_width/2)
            .attr('y', attr_height/2 + 5)
            .attr('text-anchor', 'middle')
            .attr('fill', 'white')
            .attr('font-size', '0.7em')
            .attr("font-family", "Arial")
            .text(d => d.header + " w:" + d.weight)
        
        attrgroups = tablegroups.selectAll('.attrs')
            .data(d => d.attributes)
            .enter()
            .append('g')
            .attr('transform', (d, i) => "translate(0, " + (header_height + (i)*attr_height) + ")")
            
        attrgroups.append("rect")
            .attr("width", table_width)
            .attr("height", attr_height)
            .attr("fill", "#ccc")
            .attr("stroke", "white")
            .attr("stroke-width", 2)

        attrgroups.append('text')
            .attr('x', table_width/2)
            .attr('y', attr_height/2 + 3)
            .attr('text-anchor', 'middle')
            .attr('font-size', '0.7em')
            .attr("font-family", "Arial")
            .text(d => d.attr + " w:" + d.weight)

        let get_1st_coord = (d) => 
            [d.leftTable.depth * depth_distance + table_width,
            d.leftTable.attributes.indexOf(d.att1)*attr_height + header_height + attr_height/2 + g.tableIndex[d.leftTable.depth].indexOf(d.leftTable)*table_vert_space]
       
        let get_2nd_coord = (d) => {
            if (d.leftTable.depth != d.rightTable.depth)
                return [d.rightTable.depth * depth_distance, 
                    d.rightTable.attributes.indexOf(d.att2)*attr_height + header_height + attr_height/2 + g.tableIndex[d.rightTable.depth].indexOf(d.rightTable)*table_vert_space]
            else return [d.leftTable.depth * depth_distance + table_width,
                d.rightTable.attributes.indexOf(d.att2)*attr_height + header_height + attr_height/2 + g.tableIndex[d.rightTable.depth].indexOf(d.rightTable)*table_vert_space]    
        }

        // draw edges
        edges = visg.selectAll('.edges')
            .data(g.edges)
            .enter()
            .append('path')
            .attr('stroke', 'black')
            .attr('fill', 'none')
            .attr('d', d => {
                first = get_1st_coord(d)
                second = get_2nd_coord(d)
                return line(
                    [first, 
                    [first[0] + depth_distance*0.2, first[1]],
                    [second[0] + (d.leftTable.depth == d.rightTable.depth ? 1 : -1)*depth_distance*0.2, second[1]],
                    second]
                )
            })

        d3.select(svg.node().parentNode)
            .append('div').append('text')
            .text('crossings: ' + g.getEdgeCrossings() + ', tables: ' + g.tables.length + ', edges: ' + g.edges.length)
            .style('font-family', 'Arial')
            .attr('class', 'crossing_count')

        if (algorithm != undefined && algorithm.elapsedTime != undefined){
            d3.select(svg.node().parentNode)
            .append('div').append('text')
            .text('time: ' + algorithm.elapsedTime + 'ms')
            .style('font-family', 'Arial')
            .attr('class', 'crossing_count')
        }
        
    }

    let form = document.createElement("div")
    let label1 = document.createElement("label")
    let input = document.createElement("input")
    let input2 = document.createElement("button")
    input.id = "fseed"
    input.type = "text"
    input.name = "fseed"
    label1.innerHTML = "seed: "
    label1.for = "fseed"
    form.append(label1)
    form.append(input)
    input2.innerHTML = "Generate"
    form.append(input2) 
    document.body.append(form)
    form.style.margin = "10px"
    form.style.fontFamily = "Arial"
    input2.onclick = () => {
        makeAllGraphs(input.value)
    }

    makeAllGraphs = (seed) => {
        d3.selectAll(".vis-svg").remove()
        d3.selectAll(".crossing_count").remove()
        d3.selectAll('.algorithm_header').remove()
        d3.selectAll('.rowDiv').remove()

        const svg_height = 300
        const svg_width = 600

        const svg_height_big = 800
        const svg_width_big = 1600

        const svg_height_bigger = 1600
        const svg_width_bigger = 3200

        d3.select('body').append('div')
            .text("Original")
            .attr('class', 'algorithm_header')

        g = new GraphGenerator(4, seed)
        g.generate()
        
        g.setExactWeights()
        g.sortGraph()

        rowDiv = d3.select('body').append('div')
            .style('width', '150%')
            .style('height', svg_height)
            .style('display', 'flex')
            .attr('class', 'rowDiv')

        // append svg to body
        svg = rowDiv
                .append('div')
                .style('width', '33%')
                .append('svg')
                .attr('class', 'vis-svg')
                .attr('easypz', '{"applyTransformTo":"svg > *"}')
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + svg_width + " " + svg_height)

        drawGraph(svg, g)

        g = new GraphGenerator(10, seed, [3, 6])
        g.generate()
        
        g.setExactWeights()
        g.sortGraph()

        svg_big = rowDiv
                .append('div')
                .style('width', '33%')
                .append('svg')
                .attr('class', 'vis-svg')
                .attr('easypz', '{"applyTransformTo":"svg > *"}')
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + svg_width_big + " " + svg_height_big)

        drawGraph(svg_big, g)

        g = new GraphGenerator(20, seed, [8, 15])
        g.generate()
        
        g.setExactWeights()
        g.sortGraph()

        g.setExactWeights()
        g.sortGraph()

        svg_bigger = rowDiv
                .append('div')
                .style('width', '33%')
                .append('svg')
                .attr('class', 'vis-svg')
                .attr('easypz', '{"applyTransformTo":"svg > *"}')
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + svg_width_bigger + " " + svg_height_bigger)

        drawGraph(svg_bigger, g)

        // ***
        // SWEEP
        // ***

        d3.select('body').append('div')
            .text("Sweep")
            .attr('class', 'algorithm_header')

        g = new GraphGenerator(4, seed)
        g.generate()
        
        g.setExactWeights()
        g.sortGraph()

        let sweep = new Sweep(g)
        sweep.arrange()

        g.setExactWeights()
        g.sortGraph()

        rowDiv = d3.select('body').append('div')
            .style('width', '150%')
            .style('height', svg_height)
            .style('display', 'flex')

        // append svg to body
        svg = rowDiv
                .append('div')
                .style('width', '33%')
                .append('svg')
                .attr('class', 'vis-svg')
                .attr('easypz', '{"applyTransformTo":"svg > *"}')
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + svg_width + " " + svg_height)

        drawGraph(svg, g, sweep)

        g = new GraphGenerator(10, seed, [3, 6])
        g.generate()
        
        g.setExactWeights()
        g.sortGraph()

        sweep = new Sweep(g)
        sweep.arrange()

        g.setExactWeights()
        g.sortGraph()

        svg_big = rowDiv
                .append('div')
                .style('width', '33%')
                .append('svg')
                .attr('class', 'vis-svg')
                .attr('easypz', '{"applyTransformTo":"svg > *"}')
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + svg_width_big + " " + svg_height_big)

        drawGraph(svg_big, g, sweep)

        g = new GraphGenerator(20, seed, [8, 15])
        g.generate()
        
        g.setExactWeights()
        g.sortGraph()

        sweep = new Sweep(g)
        sweep.arrange()

        g.setExactWeights()
        g.sortGraph()

        svg_bigger = rowDiv
                .append('div')
                .style('width', '33%')
                .append('svg')
                .attr('class', 'vis-svg')
                .attr('easypz', '{"applyTransformTo":"svg > *"}')
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + svg_width_bigger + " " + svg_height_bigger)

        drawGraph(svg_bigger, g, sweep)

        // ***
        // GANSNER
        // ***

        d3.select('body').append('div')
            .text("Modified Gansner [1993] (GraphViz's dot)")
            .attr('class', 'algorithm_header')

        g = new GraphGenerator(4, seed)
        g.generate()
        
        g.setExactWeights()
        g.sortGraph()

        let gansner = new Gansner(g)
        gansner.arrange()

        g.setExactWeights()
        g.sortGraph()

        rowDiv = d3.select('body').append('div')
            .style('width', '150%')
            .style('height', svg_height)
            .style('display', 'flex')

        // append svg to body
        svg = rowDiv
                .append('div')
                .style('width', '33%')
                .append('svg')
                .attr('class', 'vis-svg')
                .attr('easypz', '{"applyTransformTo":"svg > *"}')
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + svg_width + " " + svg_height)

        drawGraph(svg, g, gansner)

        g = new GraphGenerator(10, seed, [3, 6])
        g.generate()
        
        g.setExactWeights()
        g.sortGraph()

        gansner = new Gansner(g)
        gansner.arrange()

        g.setExactWeights()
        g.sortGraph()

        svg_big = rowDiv
                .append('div')
                .style('width', '33%')
                .append('svg')
                .attr('class', 'vis-svg')
                .attr('easypz', '{"applyTransformTo":"svg > *"}')
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + svg_width_big + " " + svg_height_big)

        drawGraph(svg_big, g, gansner)

        g = new GraphGenerator(20, seed, [8, 15])
        g.generate()
        
        g.setExactWeights()
        g.sortGraph()

        gansner = new Gansner(g)
        gansner.arrange()

        g.setExactWeights()
        g.sortGraph()

        svg_bigger = rowDiv
                .append('div')
                .style('width', '33%')
                .append('svg')
                .attr('class', 'vis-svg')
                .attr('easypz', '{"applyTransformTo":"svg > *"}')
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 " + svg_width_bigger + " " + svg_height_bigger)

        drawGraph(svg_bigger, g, gansner)
    }

    makeAllGraphs("hello.")


</script>

</html>